<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数据表格编辑器</title>
    <meta http-equiv="Content-Security-Policy" content="{{csp}}" />
    <script
      nonce="{{resource-nonce}}"
      src="{{node-resources-uri}}/jquery/dist/jquery.slim.min.js"
    ></script>
    <script
      nonce="{{resource-nonce}}"
      src="{{node-resources-uri}}/tabulator-tables/dist/js/tabulator.min.js"
    ></script>
    <link
      rel="stylesheet"
      href="{{node-resources-uri}}/tabulator-tables/dist/css/tabulator.min.css"
    />
    <link
      rel="stylesheet"
      href="{{node-resources-uri}}/@vscode/codicons/dist/codicon.css"
    />
    <link rel="stylesheet" href="{{resources-uri}}/global.css" />
  </head>
  <body class="grid-panel">
    <script
      nonce="{{resource-nonce}}"
      src="{{resources-uri}}/global.js"
    ></script>
    <div class="toolbar">
      <button
        class="btn btn-secondary btn-small"
        id="btn-save"
        title="保存修改到数据库"
      >
        <span class="codicon codicon-save" aria-hidden="true"></span>
        <span class="sr-only">保存</span>
      </button>
      <button
        class="btn btn-secondary btn-small"
        id="btn-refresh"
        title="刷新表格数据"
      >
        <span class="codicon codicon-refresh" aria-hidden="true"></span>
        <span class="sr-only">刷新</span>
      </button>
      <button class="btn btn-secondary btn-small" id="btn-add" title="添加新行">
        <span class="codicon codicon-add" aria-hidden="true"></span>
        <span class="sr-only">新增</span>
      </button>
      <button
        class="btn btn-secondary btn-small"
        id="btn-delete"
        title="删除选中行"
      >
        <span class="codicon codicon-trash" aria-hidden="true"></span>
        <span class="sr-only">删除</span>
      </button>
      <div style="flex: 1"></div>
      <button
        class="btn btn-secondary btn-small"
        id="btn-export-csv"
        title="导出为 CSV 文件"
      >
        <span class="codicon codicon-archive" aria-hidden="true"></span>
        <span class="sr-only">CSV</span>
      </button>
      <button
        class="btn btn-secondary btn-small"
        id="btn-export-json"
        title="导出为 JSON 文件"
      >
        <span class="codicon codicon-file" aria-hidden="true"></span>
        <span class="sr-only">JSON</span>
      </button>
      <button
        class="btn btn-secondary btn-small"
        id="btn-export-sql"
        title="导出为 SQL 语句"
      >
        <span class="codicon codicon-database" aria-hidden="true"></span>
        <span class="sr-only">SQL</span>
      </button>
    </div>

    <div class="filter-row">
      <div class="filter-group">
        <label for="input-where" class="filter-label">WHERE</label>
        <input
          type="text"
          id="input-where"
          class="filter-input"
          placeholder="condition (e.g., status = 'Active')"
        />
      </div>
      <div class="filter-group">
        <label for="input-orderby" class="filter-label">ORDER BY</label>
        <input
          type="text"
          id="input-orderby"
          class="filter-input"
          placeholder="columns (e.g., id ASC, name DESC)"
        />
      </div>
    </div>
		
    <div class="table-wrapper">
      <table id="grid" class="display">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <script nonce="{{resource-nonce}}">
      // ========== VSCode API & 初始化 ==========
      let vscode = null;
      if (window.vscode) {
        vscode = window.vscode;
      } else {
        vscode = acquireVsCodeApi ? acquireVsCodeApi() : null;
      }
      const dbTable = new DatabaseTableData({
        tableSelector: "#grid",
        vscode
      });
			$("#btn-add").on("click", dbTable.addRow);
			$("#btn-refresh").on("click", dbTable.refreshTable);
      $("#btn-save").on("click", () =>
        vscode.postMessage({ command: "save", data: dbTable.changedRows })
      );
      window.addEventListener("message", (event) => {
        const { command, data } = event.data;

        if (command === "load") {
          dbTable.init(data.columnDefs, data.rowData);
        }
      });
    </script>
  </body>
</html>
