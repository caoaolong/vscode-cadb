<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>数据库配置</title>
    <link rel="stylesheet" href="{{global-css}}" />
  </head>
  <body class="config-container">
    <div class="container">
      <div class="header">
        <h1>数据库连接配置</h1>
        <p class="subtitle">配置数据库连接信息，支持多种数据库类型</p>
      </div>

      <form id="dbForm">
        <div class="form-group">
          <div class="form-item">
            <label for="dbType">数据库类型</label>
            <select name="dbType" id="dbType" required>
              <option value="mysql">MySQL</option>
              <option value="postgres">PostgreSQL</option>
              <option value="sqlite">SQLite</option>
              <option value="mssql">SQL Server</option>
            </select>
          </div>

          <div class="form-item">
            <label for="name">连接名称</label>
            <input
              type="text"
              name="name"
              id="name"
              placeholder="例如：生产数据库"
              required
            />
            <div class="hint">给此连接起一个易于识别的名称</div>
          </div>
        </div>

        <div class="form-divider"></div>

        <div id="standardConfig" class="form-group">
          <div class="field-group">
            <div class="form-item">
              <label for="host">主机地址</label>
              <input
                type="text"
                name="host"
                id="host"
                placeholder="localhost 或 IP 地址"
              />
            </div>
            <div class="form-item">
              <label for="port">端口</label>
              <input
                type="number"
                name="port"
                id="port"
                placeholder="3306"
                min="1"
                max="65535"
              />
            </div>
          </div>

          <div class="field-group">
            <div class="form-item">
              <label for="user">用户名</label>
              <input
                type="text"
                name="username"
                id="user"
                placeholder="数据库用户名"
              />
            </div>
            <div class="form-item">
              <label for="password">密码</label>
              <input
                type="password"
                name="password"
                id="password"
                placeholder="数据库密码"
              />
            </div>
          </div>

          <div class="form-item">
            <label for="database">数据库名</label>
            <input
              type="text"
              name="database"
              id="database"
              placeholder="数据库名称"
            />
            <div class="hint">要连接的数据库名称</div>
          </div>
        </div>

        <div id="sqliteConfig" class="form-group" style="display: none">
          <div class="form-item">
            <label for="sqlitePath">文件路径</label>
            <input
              type="text"
              name="database"
              id="sqlitePath"
              placeholder="/path/to/database.db"
            />
            <div class="hint">SQLite 数据库文件的完整路径</div>
          </div>
        </div>

        <div class="form-divider"></div>

        <div class="button-group">
          <button type="button" id="testBtn" class="btn-secondary">
            测试连接
          </button>
          <button type="button" id="connectBtn" class="btn-primary">
            连接并保存
          </button>
        </div>

        <div
          id="status"
          class="status-message"
          role="status"
          aria-live="polite"
        ></div>
      </form>
    </div>
    <script src="{{global-js}}"></script>
    <script>
      const vscode =
        typeof acquireVsCodeApi === "function" ? acquireVsCodeApi() : null;

      class DatabaseConfigForm {
        constructor() {
          this.dbTypeEl = document.getElementById("dbType");
          this.nameEl = document.getElementById("name");
          this.hostEl = document.getElementById("host");
          this.portEl = document.getElementById("port");
          this.userEl = document.getElementById("user");
          this.passwordEl = document.getElementById("password");
          this.databaseEl = document.getElementById("database");
          this.sqlitePathEl = document.getElementById("sqlitePath");
          this.statusEl = document.getElementById("status");
          this.testBtn = document.getElementById("testBtn");
          this.connectBtn = document.getElementById("connectBtn");
          this.standardConfig = document.getElementById("standardConfig");
          this.sqliteConfig = document.getElementById("sqliteConfig");

          this.init();
        }

        init() {
          this.setupEventListeners();
          this.listenToMessages();
          this.setDefaultPort();
        }

        setupEventListeners() {
          this.dbTypeEl.addEventListener("change", () => {
            this.onDatabaseTypeChange();
            this.setDefaultPort();
          });

          this.testBtn.addEventListener("click", (e) => {
            e.preventDefault();
            this.testConnection();
          });

          this.connectBtn.addEventListener("click", (e) => {
            e.preventDefault();
            this.saveConnection();
          });
        }

        onDatabaseTypeChange() {
          const type = this.dbTypeEl.value;
          if (type === "sqlite") {
            this.standardConfig.style.display = "none";
            this.sqliteConfig.style.display = "block";
          } else {
            this.standardConfig.style.display = "block";
            this.sqliteConfig.style.display = "none";
          }
        }

        setDefaultPort() {
          const type = this.dbTypeEl.value;
          const defaultPorts = {
            mysql: 3306,
            postgres: 5432,
            mssql: 1433,
          };
          if (defaultPorts[type]) {
            this.portEl.placeholder = String(defaultPorts[type]);
          }
        }

        getFormData() {
          const type = this.dbTypeEl.value;
          return {
            type: "datasource",
            dbType: type,
            name: this.nameEl.value.trim(),
            host: this.hostEl.value.trim(),
            port: this.portEl.value ? parseInt(this.portEl.value) : null,
            username: this.userEl.value.trim(),
            password: this.passwordEl.value,
            database:
              type === "sqlite"
                ? this.sqlitePathEl.value.trim()
                : this.databaseEl.value.trim(),
          };
        }

        validateForm() {
          const data = this.getFormData();
          if (!data.name) {
            this.showStatus("请输入连接名称", "error");
            return false;
          }
          if (data.dbType !== "sqlite") {
            if (!data.host) {
              this.showStatus("请输入主机地址", "error");
              return false;
            }
            if (!data.database) {
              this.showStatus("请输入数据库名", "error");
              return false;
            }
          } else {
            if (!data.database) {
              this.showStatus("请输入 SQLite 文件路径", "error");
              return false;
            }
          }
          return true;
        }

        testConnection() {
          if (!this.validateForm()) return;
          if (!vscode) {
            this.showStatus("未在 VS Code Webview 中运行", "error");
            return;
          }
          this.setButtonsDisabled(true);
          this.showStatus("正在测试连接...", "info");
          vscode.postMessage({ command: "test", payload: this.getFormData() });
        }

        saveConnection() {
          if (!this.validateForm()) return;
          if (!vscode) {
            this.showStatus("未在 VS Code Webview 中运行", "error");
            return;
          }
          this.setButtonsDisabled(true);
          this.showStatus("正在保存配置...", "info");
          vscode.postMessage({ command: "save", payload: this.getFormData() });
        }

        listenToMessages() {
          window.addEventListener("message", (event) => {
            const message = event.data;
            if (!message || !message.command) return;

            switch (message.command) {
              case "status":
                const isSuccess = message.success !== false;
                this.showStatus(
                  message.message || "",
                  isSuccess ? "success" : "error"
                );
                this.setButtonsDisabled(false);
                break;
              case "setValues":
                this.loadValues(message.values || {});
                break;
            }
          });
        }

        loadValues(values) {
          Object.keys(values).forEach((key) => {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) {
              el.value = values[key];
            }
          });
          this.onDatabaseTypeChange();
        }

        showStatus(message, type = "info") {
          this.statusEl.textContent = message;
          this.statusEl.className = `status-message show ${type}`;
        }

        setButtonsDisabled(disabled) {
          this.testBtn.disabled = disabled;
          this.connectBtn.disabled = disabled;
        }
      }

      new DatabaseConfigForm();
    </script>
  </body>
</html>
